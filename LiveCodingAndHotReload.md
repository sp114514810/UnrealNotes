# 【UE5】（新手向）我的蓝图怎么突然坏掉了？——浅谈实时代码编写（Live Coding）和热重载（Hot Reload）

> [!Note]
>
> 省流版：开启 Live Coding，关闭重实例化（Reinstancing），关闭编辑器再编译是目前最稳妥的工作流。

## 前言

众所周知（存疑），虚幻引擎里有几大被诅咒的功能：热重载、蓝图结构体、CAC（ChildActorComponent），这些功能本意是好的，但是实现上缺乏健壮性并且短期内难以解决。

蓝图结构体的问题之前简单聊过了，今天来聊聊堪称“蓝图毁灭者”的热重载（Hot Reload），以及它的替代者 LC（Live Coding，实时代码编写）。

在一些开发者刚开始接触 C++ 时，可能会遇到这样的问题：

- 为什么编译成功后我的变量/函数没有出现在蓝图中？
- 为什么我的更改在重启编辑器后丢失了？
- 为什么我在构造函数中改动没有生效？
- 为什么我的编辑器无缘无故崩溃了？
- 为什么我的资产损坏了？

以上这些都是使用热重载和 LC 可能导致的症状。

> UE 的热重载糟糕到有人专门注册了一个顶级域名来警示世人：`hotreloadsucks.com`，本文大部分内容也是这些文章的中文版总结和补充。

> [!Tip]
>
> 如果你看到有教程告诉你出于教育目的可以暂时使用热重载，你也应该避免使用它。

## 什么是热重载和 Live Coding，为什么需要它们？

C++ 作为一种典型的**静态类型/编译语言**（暂且不论这些年即时编译（JIT）技术的发展），编译器需要提前知道所有类型的大小和排列，以生成直接运行在CPU上的机器码，类型的大小和排列在编译后无法改变。

编译语言的优点是极佳的运行速度，但缺点是导致了更长的开发和调试时间，在没有热重载的时代，开发者在代码编写的过程中不得不频繁地重启程序。

UE 的热重载（以及 LC）便是为了解决这个问题而被开发出来，能在不需要重启编辑器的情况下进行代码更改。

Live Coding（基于Live++）的目的和热重载一样，为了在引擎运行时使 C++ 代码修改直接生效，并在 UE 4.22 版本被加入用于替换热重载。

> [!Note]
>
> 在 UE 的语境下，热重载和其他地方的热重载可能存在着不同的涵义。

## 为什么不推荐使用热重载，以及怎么关闭热重载？

前文提到了，C++ 类型的大小和排列在编译后无法改变，那么热重载是如何在运行时改变引擎内容的？

答案是它没有、也无法修改之前编译生成的内容，而是通过编译并加载新的文件来实现内容的改变。

然而理想很丰满，现实却异常骨感，但是实际的使用中，热重载在处理头文件以及构造/析构函数的改动时表现不佳，常常导致运行结果异常，甚至引发引擎崩溃。

而且在资产层面，和蓝图结构体一样，热重载存在着**静默地**造成资产永久损坏的风险。由于热重载的实现，资产并不是真正的被修改并完全重新加载，当你保存资产时，引擎可能会错误地保存热重载生成的临时数据，从而造成资产异常。

> [!Note]
>
> 由于带来的严重问题，热重载实际上几乎已经被弃用并不再维护，在后续版本也许会和`蓝图本地化`一样被删除。

可以通过两种办法关闭热重载：开启 LC 和改动引擎代码；对于官方发布二进制版引擎，开启 LC 是唯一的做法。

> [!Tip]
>
> 开启 LC 最大的作用是为了封印热重载，**你不一定会用到它，但千万不要关**。

> [!Note]
>
> 在关闭 LC 的情况下，热重载会在这些情况下偷偷启动：
>
> - 在开启编辑器的情况下在 IDE 中编译
> - 使用编辑器里的编译按钮
> - 使用编辑器里的“新建 C++ 类”
>   - （这项可以通过关闭`编辑（Edit）> 编辑器偏好设置（Editor Preferences）> 实时代码编写（Live Coding）> 自动编译新添加C++类（Automatically Compile Newly Added C++ Classes）`来避免）
>
> 如果你不小心唤起了热重载，关闭编辑器并**不要保存**任何资产可以避免资产损坏。

相比热重载，其替代品 Live Coding (Live++) 的实现则安全得多，只能由用户主动触发，在带来热重载类似体验的同时不会造成永久性的损坏。

LC 既能封印住热重载，又能安全地带来较为顺畅的开发体验，到这里问题本来应该解决了。

直到 Epic 在 UE 5 为 LC 移植了热重载的重实例化（Reinstancing）功能，问题又开始出现了，目前重实例化（Reinstancing）糟糕的实现使得 LC 和热重载存在一样的**永久性损坏资产**的风险，并且重实例化（Reinstancing）是**默认启用**的。

因此从 UE 5 开始，要在`编辑（Edit）> 编辑器偏好设置（Editor Preferences）> 实时代码编写（Live Coding）`中关闭重实例化（Reinstancing），才能安全地使用 LC。

> [!Tip]
>
> 可以在`项目文件夹/Config/DefaultEditorPerProjectUserSettings.ini`文件中加入以下内容来更改默认选项，以避免团队中的资产损坏：
>
> ```ini
> ; Enable LiveCoding to disable Hot Reload
> ; Disable reinstancing to prevent blueprint corrupts
> [/Script/LiveCoding.LiveCodingSettings]
> bEnabled=True
> bEnableReinstancing=False
> ```

> [!Note]
>
> Q: 如果我用的是 Linux/Mac 没有 Live Coding 怎么办？
>
> A: Live Coding 目前只支持 Windows 平台，可以通过改动引擎代码来关闭热重载；如果使用官方发布的编译版引擎，你只能忍受着热重载的诅咒并希望它不要发生（每次关编辑器编译）。

## Live Coding 的使用和限制

可以通过按下 `Ctrl`+`Alt`+`F11` 或者编辑器上的按钮运行 Live Coding

那么有了 LC，是不是就不用每次都关编辑器再编译了？

遗憾的是大多数时候还是会关编辑器编译，LC 实际上和热重载有着类似的功能限制，在使用时有必要了解它的一些特性。

首先，使用 LC 产生的更改通过内存补丁实现，因此在关闭 UE 编辑器并在 IDE 中重新编译后才会永久生效。

其次，关闭了重实例化的 LC 能处理的情况大致有：

- 更改现有函数（构造函数除外）
- 增加非虚或非反射函数
- 增加静态变量
- 增加非反射的新类型

> [!Note]
>
> 关闭了重实例化后，LC 会忽略头文件中反射内容（例如 UPROPERTY、USTRUCT）的改动。

简单来说，LC 只适合用来处理 `.cpp` 中除构造函数外其他函数体的改动。

> [!Tip]
>
> 与常规编译或热重载不同，Live Coding 在编译前不会自动保存 IDE 中的代码文件。因此，如果未保存更改，编译可能不会生效。

有人可能会问：不停重启编辑器很影响开发体验怎么办？

确实是这样，Epic 也在想办法改善这些问题（尽管 Reinstancing 仍然很糟糕），但随着开发经验的增长（“人肉编译能力”的提高），你重启编辑器的频率会越来越低。使用蓝图进行实验性功能的编写。

另外现有的第三方解决方案也很多，例如可以在 UE 中使用 AngelScript、Lua、C# 等脚本语言的社区项目，或者期待将来版本官方 Verse 语言的加入。

> [!Note]
>
> Q: 受热重载和 Reinstancing 影响损坏的蓝图可以拯救吗？
>
> A: 重复 Component 的情况可以尝试使用 [Component Pointer Fixer](https://github.com/Duroxxigar/ComponentPointerFixer) 项目修复，其他情况只能全部**删除重做**。

# 参考文章

- [Stop Live Coding: The broken promise of a Unity-like workflow in Unreal](https://dev.northstarhana.com/Unreal-Engine/Stop-Live-Coding)
- [Hot Reload and Live Coding](https://unrealcommunity.wiki/live-compiling-in-unreal-projects-tp14jcgs)

> 免责声明：
> 截至本文内容发布时 UE 版本为 5.6，引擎内容在将来也许会有改变，不保证文章内容长期有效。

> 如有疏漏或不当之处，欢迎指出交流。
>
> ---
>
> This work is licensed under CC BY-NC 4.0
